---
title: "Squirreling the Stats: A Demographic Tale"
output: 
  html_document:
    code_folding: hide
    always_allow_html: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
library(plotly)
library(sf)
```

#### In this section, we will be looking at squirrel demographics, such as fur color and age. 

First, we will import the cleaned squirrel data and a shapefile of Central Park. 

```{r}
squirrel_census = 
  read_csv("data/clean_squirrel_2018.csv")

central_park_map = st_read(here::here('central_park', 'CentralPark.shp'), quiet = TRUE)
```

There are a total of `r nrow(squirrel_census)` squirrel observations in the data set. 


#### Let's first explore squirrel ages. 

```{r, fig.width= 6, fig.align='center'}
squirrel_census |> 
  filter(age != "?") |> 
  ggplot() +
  geom_sf(data = central_park_map, color = "grey") +
  geom_point(
    aes(x = x, y = y, color = age),
    size = 0.5, alpha = 0.75) +
    theme_void(base_size = 15) +
  theme(legend.position = 'bottom') +
  guides(color = guide_legend(
    title.position = "top",
    override.aes = list(size = 3))) +
  scale_color_manual(values = c("Adult" = "aquamarine3", "Juvenile" = "coral1")) +
  labs(title = "Squirrel Age",
       color = "Age")
```

```{r}
squirrel_census |> 
  filter(age != "?") |> 
  group_by(age) |> 
  count(age) |> 
  mutate(Age = fct_reorder(age, n)) |> 
  plot_ly (x = ~age, y = ~n, color = ~age,
         type = "bar") |> 
  layout(
    xaxis = list(title = "Age"),   
    yaxis = list(title = "Number of Squirrels") 
  )
```
It appears that the majority of observed squirrels are adults. There are 2503 adult squirrels in the data set and only 319 juvenile squirrels. 

#### Let's also look at primary and highlight fur color.


```{r, fig.width= 6, fig.align='center'}
ggplot() +
  geom_sf(data = central_park_map, color = "grey") +
  geom_point(
    data = squirrel_census,
    aes(x = x, y = y, color = primary_fur_color),
    size = 0.5, alpha = 0.75) +
    theme_void(base_size = 15) +
  theme(legend.position = 'bottom') +
  guides(color = guide_legend(
    title.position = "top",
    override.aes = list(size = 3))) +
  labs(color = 'Primary Fur Color',
       title = 'Squirrel Fur Color Distribution') +
  scale_color_manual(values = c("Black" = "black", "Gray" = "azure4", "Cinnamon" = "darkorange3")) 
```


```{r}
squirrel_census |> 
  filter(!(combination_of_primary_and_highlight_color %in% c("N/A", "?"))) |> 
  group_by(primary_fur_color) |> 
  count(primary_fur_color) |> 
  mutate(primary_fur_color = fct_reorder(primary_fur_color, n)) |> 
  plot_ly (x = ~primary_fur_color, y = ~n, color = ~primary_fur_color,
         type = "bar", colors = "viridis") |> 
  layout(
    xaxis = list(title = "Primary Fur Color"),   
    yaxis = list(title = "Number of Squirrels") 
  )
```

```{r}
squirrel_census |> 
  rename(combination_fur_color = combination_of_primary_and_highlight_color) |> 
  count(combination_fur_color) |> 
  mutate(combination_fur_color = fct_reorder(combination_fur_color, n)) |> 
  plot_ly (x = ~combination_fur_color, y = ~n, color = ~combination_fur_color,
         type = "bar", colors = "viridis") |> 
  layout(
    xaxis = list(title = "Fur Color"),   
    yaxis = list(title = "Number of Squirrels") 
  )
```

#### Is there a difference in primary fur color depending on age? 

```{r}
squirrel_fur_age = 
  squirrel_census |> 
  filter(age != "?") |> 
  group_by(age, primary_fur_color) |> 
  summarise(count = n()) |> 
  mutate(percent = round(count / sum(count) * 100, 1))

squirrel_fur_age |> 
  mutate(hover_text = str_c("Age: ", age, "<br>Primary Fur Color: ", primary_fur_color, "<br>Percent: ", percent, "%")) |> 
  plot_ly (x = ~age, y = ~percent, color = ~primary_fur_color,
         type = "bar", colors = "viridis", text = ~hover_text) |> 
  layout(
    xaxis = list(title = "Age"),   
    yaxis = list(title = "Percent of Squirrels (%)")
  )
```


### Hypothesis Testing


We're interested in investigating the relationship between `shift` (morning or afternoon sighting) and the locations of the squirrels (ground plane, or above ground)

##### State Hypotheses

* H0: There is no significant association between shift and location
* H1: There is a significant association between shift and location

##### Assumptions

The Chi-Square Test of Independence assumes that

1. Observations must be independent

2. Data must be categorical in nature

3. The expected frequency in each cell in the contingency table should be greater than 5

4. Data should be collected via random sampling

5. The overall sample size should be large 

We know assumptions 1, 2, 4, 5 and five are met. Let's double check the cell frequencies by generating a contingency table.

##### Create contingency table
```{r}
contingency_table =
  squirrel_census |> 
  select(shift, location) |> 
  summarise_all(factor) |> 
  table()
```


##### Conduct Test
```{r}
chi_square_result = chisq.test(contingency_table)

print(chi_square_result)
```


##### Final Conclusion
At the 0.05 level of significance, there is evidence to suggest that the distribution of locations is not independent of the shift;
in other words, there is a significant association between the time of day and the location where squirrels are observed.

This may mean that squirrels exhibit different location preferences or behaviors during the morning (AM) compared to the afternoon (PM). Squirrels are known to be diurnal animals, so the results of the chi-square test serves as additional evidence. Since squirrels have been observed to be active more during dawn and dusk, this makes a lot of sense. 